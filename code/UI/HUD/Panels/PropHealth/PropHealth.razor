@using Sandbox;
@using Sandbox.UI;
@inherits Panel

@{
	var player = FWPlayerController.Local;

	var gs = GameSystem.Instance;

	if (!player.IsValid() || !ShowPanel || !CurrentProp.IsValid() || !gs.IsValid() || (!gs?.CurrentGameModeComponent?.CurrentRound.IsValid() ?? false))
		return;
}

<root>
	<div class="bar">
		<div class="inner" style="width: @(CurrentProp?.Health / CurrentProp?.MaxHealth * 100)%;"></div>
		<div class="health">@CurrentProp?.Health / @CurrentProp?.MaxHealth</div>
	</div>
</root>

@code {
	public SceneTraceResult tr => Scene.Trace.Ray(Scene.Camera.ScreenNormalToRay(0.5f), 250)
	.WithoutTags(FW.Tags.Player, FW.Tags.Ragdoll)
	.Run();

	public FortwarsProp CurrentProp => tr.GameObject?.Components.Get<FortwarsProp>();

	public bool ShowPanel { get; set; }

	public override void Tick()
	{
		base.Tick();

		if (!Scene.Camera.IsValid())
		{
			ShowPanel = false;
			return;
		}

		var hitObject = tr.GameObject;
		ShowPanel = tr.Hit && hitObject.IsValid() && hitObject.Components.TryGet<FortwarsProp>(out var fortwarsProp,
		FindMode.EverythingInSelfAndParent) && fortwarsProp.IsBuilding;

		if (ShowPanel)
		{
			// Start calculating panel position
			var screenPosition = Scene.Camera.PointToScreenPixels(tr.GameObject.WorldPosition, out _);

			// Turn screen position into a panel position
			var panelPosition = screenPosition * ScaleFromScreen;

			// Floor it / make it use integers
			var ipx = (int)panelPosition.x;
			var ipy = (int)panelPosition.y;

			// Offset it by half the panel size
			ipx -= 110;

			// Set position
			Style.Left = Length.Pixels(ipx);
			Style.Top = Length.Pixels(ipy);

			StateHasChanged();
		}
	}

	protected override int BuildHash()
	{
		var player = FWPlayerController.Local;
		return System.HashCode.Combine(player?.Inventory?.CurrentWeaponData?.Name, ShowPanel);
	}
}
